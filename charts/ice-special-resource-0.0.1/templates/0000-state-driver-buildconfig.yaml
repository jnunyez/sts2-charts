---
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  labels:
    app: {{.Values.specialresource.metadata.name}}-{{.Values.groupName.driverContainer}}
  name: {{.Values.specialresource.metadata.name}}-{{.Values.groupName.driverContainer}}
---
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  labels:
    app: {{.Values.specialresource.metadata.name}}-{{.Values.groupName.driverBuild}}
  name: {{.Values.specialresource.metadata.name}}-{{.Values.groupName.driverBuild}}
  namespace: {{.Values.specialresource.spec.namespace}}
  annotations:
    specialresource.openshift.io/wait: "true"
    specialresource.openshift.io/driver-container-vendor: "ice-special-resource"
spec:
  nodeSelector:
    feature.node.kubernetes.io/custom-intel.e810_c.devices: "true"
  resources:
    limits:
      ephemeral-storage: "10Gi"
  runPolicy: "Serial"
  triggers:
    - type: "ConfigChange"
    - type: "ImageChange"
  source:
    dockerfile: |
      {{- if .Values.runArgs.buildIce }}
      # STAGE 0
      ARG ICE_SRC=quay.io/silicom/ice-driver-src:1.7.16
      ARG BUILD_BASE
      FROM $ICE_SRC
      RUN echo commmand

      # STAGE 1
      FROM $BUILD_BASE
      MAINTAINER "rmr@silicom.dk"
      ARG ICE_VERSION
      ARG ICE_SRC
      WORKDIR /build
      COPY --from=0 /charts/ice.tgz ice.tgz
      RUN tar xvf ice.tgz
      RUN make -C ice-$ICE_VERSION/src -j4
      {{- end }}

      # STAGE 2
      FROM registry.access.redhat.com/ubi8/ubi-minimal
      {{- if .Values.runArgs.buildIce }}
      RUN microdnf install pciutils kmod procps iproute nc util-linux
      ARG ICE_VERSION
      COPY --from=1 /build/ice-$ICE_VERSION/src/*.ko /
      COPY --from=1 /build/ice-$ICE_VERSION/ddp/*.pkg /root/ice.pkg
      {{- end }}
  strategy:
    dockerStrategy:
      buildArgs:
        {{- range $arg := .Values.buildArgs }}
        - name: {{ $arg.name }}
          value: {{ $arg.value }}
        {{- end }}
        - name: BUILD_BASE
#          value: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:aea6d1e324558e2484bb14d6ffb8455fc752628c12118e8f33c8ae0a31990e06
          value: {{.Values.driverToolkitImage}}
  output:
    to:
      kind: DockerImage
      name: "{{.Values.driverRegistry}}/{{.Values.specialresource.metadata.name}}-{{.Values.groupName.driverContainer}}:v{{.Values.kernelFullVersion}}"
